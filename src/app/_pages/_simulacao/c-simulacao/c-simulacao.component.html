<div class="main-container">
    <div class="content-wrapper">
        <div class="painel">
            <header>
                <div class="header-actions">
                    <button pButton
                            type="button"
                            icon="pi pi-arrow-left"
                            class="p-button-outlined p-button-sm back-button"
                            routerLink="/painelcliente"
                            pTooltip="Voltar ao Painel">
                    </button>
                </div>
                <h2>Simule seu financiamento agora!</h2>
                <p>Escolha o veículo dos seus sonhos e veja as condições ideias para o seu orçamento. </p>
            </header>

            <!-- formulario -->
            <form class="form-simulacao">
                <div class="consulta-fipe-container">
                    <div class="card">
                        <h2>Consulta Tabela FIPE</h2>
                        <p class="subtitle">Consulte o valor de veículos utilizando a tabela FIPE oficial</p>

                        <!-- carregando -->
                        <div *ngIf="carregando && !marcasListagem.length" class="loading-container">
                            <p-progressSpinner></p-progressSpinner>
                            <p>Carregando...</p>
                        </div>

                        <div *ngIf="mensagens.length > 0" class="error-message p-mb-3">
                            <p-messages [(value)]="mensagens"></p-messages>
                        </div>

                        <!-- forms principal -->
                        <div class="form-container" *ngIf="!carregando || marcasListagem.length">
                            <div class="p-fluid grid">
                                
                                <div class="field col-12 md:col-6 lg:col-3">
                                    <label for="tipoVeiculo">Tipo de Veículo</label>
                                    <p-dropdown
                                        id="tipoVeiculo"
                                        [options]="tiposVeiculo"
                                        [(ngModel)]="tipoVeiculo"
                                        (onChange)="onTipoVeiculoChange()"
                                        placeholder="Selecione o tipo"
                                        [disabled]="carregando"
                                        appendTo="body"
                                        name="tipoVeiculo">
                                    </p-dropdown>
                                </div>

                                <div class="field col-12 md:col-6 lg:col-3">
                                    <label for="marca">Marca</label>
                                    <p-dropdown
                                        id="marca"
                                        [options]="marcasListagem"
                                        [(ngModel)]="marcaSelecionada"
                                        (onChange)="onMarcaChange()"
                                        placeholder="Selecione a marca"
                                        [disabled]="!marcasListagem.length || carregando"
                                        appendTo="body"
                                        name="marca">
                                        <ng-template pTemplate="empty">
                                            <div class="empty-message">
                                                {{ carregando ? 'Carregando...' : 'Nenhuma marca encontrada' }}
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                </div>

                                <div class="field col-12 md:col-6 lg:col-3">
                                    <label for="modelo">Modelo</label>
                                    <p-dropdown
                                        id="modelo"
                                        [options]="modelosListagem"
                                        [(ngModel)]="modeloSelecionado"
                                        (onChange)="onModeloChange()"
                                        placeholder="Selecione o modelo"
                                        [disabled]="!modelosListagem.length || carregando"
                                        appendTo="body"
                                        name="modelo">
                                        <ng-template pTemplate="empty">
                                            <div class="empty-message">
                                                {{ !marcaSelecionada ? 'Selecione uma marca' : (carregando ? 'Carregando...' : 'Nenhum modelo encontrado') }}
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                </div>

                                <div class="field col-12 md:col-6 lg:col-3">
                                    <label for="ano">Ano</label>
                                    <p-dropdown
                                        id="ano"
                                        [options]="anosListagem"
                                        [(ngModel)]="anoSelecionado"
                                        (onChange)="onAnoChange()"
                                        placeholder="Selecione o ano"
                                        [disabled]="!anosListagem.length || carregando"
                                        appendTo="body"
                                        name="ano">
                                        <ng-template pTemplate="empty">
                                            <div class="empty-message">
                                                {{ !modeloSelecionado ? 'Selecione um modelo' : (carregando ? 'Carregando...' : 'Nenhum ano encontrado') }}
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                </div>

                            </div>

                            <!-- carregando durante consultas -->
                            <div *ngIf="carregando && marcasListagem.length" class="loading-inline">
                                <p-progressSpinner styleClass="w-1rem h-1rem" strokeWidth="4"></p-progressSpinner>
                                <span class="ml-2">Consultando...</span>
                            </div>

                            <!-- limpar formulario inicial -->
                            <div class="flex justify-content-end mt-3">
                                <button 
                                    pButton 
                                    pRipple
                                    type="button" 
                                    label="Limpar Consulta" 
                                    class="btn-secundary"
                                    (click)="limparConsulta()"
                                    [disabled]="carregando">
                                </button>
                            </div>
                        </div>

                        <!-- resultado da consulta a FIPE -->
                        <div *ngIf="informacoesFipe" class="resultado-container mt-4">
                            <p-card header="Resultado da Consulta FIPE" styleClass="resultado-card">
                                <div class="grid">
                                    <div class="col-12 md:col-6">
                                        <div class="info-item">
                                            <strong>Valor do Veículo:</strong>
                                            <span class="valor-fipe">{{ informacoesFipe.Valor }}</span>
                                        </div>

                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div class="info-item">
                                            <strong>Combustível:</strong>
                                            <span>{{ informacoesFipe.Combustivel }}</span>
                                        </div>
                                        <div class="info-item">
                                            <strong>Código FIPE:</strong>
                                            <span>{{ informacoesFipe.CodigoFipe }}</span>
                                        </div>
                                        <div class="info-item">
                                            <strong>Mês Referência:</strong>
                                            <span>{{ informacoesFipe.MesReferencia }}</span>
                                        </div>
                                    </div>
                                </div>
                            </p-card>
                        </div>

                        <!-- empty state -->
                        <div *ngIf="!informacoesFipe && formularioValido && !carregando" class="empty-state mt-4">
                            <p-card>
                                <div class="empty-state-content">
                                    <i class="pi pi-info-circle empty-state-icon"></i>
                                    <h3>Consulta Completa</h3>
                                    <p>Selecione o ano do veículo para visualizar o valor FIPE</p>
                                </div>
                            </p-card>
                        </div>
                    </div>
                </div>

                <!-- dados de simulacao -->
                <div *ngIf="informacoesFipe" class="campos-simulacao mt-4">
                    <p-card header="Dados para Simulação">
                        <div class="grid">
                            <div class="field col-12 md:col-6">
                                <label for="valorEntrada">Valor de Entrada (R$)</label>
                                <p-inputNumber 
                                    id="valorEntrada"
                                    [(ngModel)]="valorEntrada"
                                    mode="currency" 
                                    currency="BRL" 
                                    locale="pt-BR"
                                    [min]="0"
                                    [max]="valorVeiculoNumerico"
                                    placeholder="Digite o valor da entrada"
                                    name="valorEntrada">
                                </p-inputNumber>
                                <small class="p-d-block p-mt-1">
                                    Valor máximo: {{ valorVeiculoNumerico | currency:'BRL' }}
                                </small>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label for="parcelas">Número de Parcelas</label>
                                <p-dropdown
                                    id="parcelas"
                                    [options]="opcoesParcelas"
                                    [(ngModel)]="parcelasSelecionadas"
                                    placeholder="Selecione as parcelas"
                                    name="parcelas">
                                </p-dropdown>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label for="taxaJuros">Taxa de Juros (% ao mês)</label>
                                <p-inputNumber 
                                    id="taxaJuros"
                                    [(ngModel)]="taxaJuros"
                                    mode="decimal" 
                                    [min]="0"
                                    [max]="20"
                                    [minFractionDigits]="2"
                                    [maxFractionDigits]="2"
                                    placeholder="0.00"
                                    suffix="%"
                                    name="taxaJuros">
                                </p-inputNumber>
                            </div>

                            <div class="field col-12 md:col-6">
                                <label for="rendaMensal">Renda Mensal (R$)</label>
                                <p-inputNumber 
                                    id="rendaMensal"
                                    [(ngModel)]="rendaMensal"
                                    mode="currency" 
                                    currency="BRL" 
                                    locale="pt-BR"
                                    [min]="0"
                                    placeholder="Digite sua renda mensal"
                                    name="rendaMensal">
                                </p-inputNumber>
                            </div>
                        </div>
                    </p-card>
                </div>

                <!-- resultado da simulacao -->
                <div *ngIf="resultadoSimulacao && informacoesFipe" class="resultado-simulacao mt-4">
                    <p-card header="Resultado da Simulação" styleClass="resultado-simulacao-card">
                        <div class="grid">
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <strong>Valor Financiado:</strong>
                                    <span>{{ resultadoSimulacao.valorFinanciado | currency:'BRL' }}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Valor da Parcela:</strong>
                                    <span class="valor-parcela">{{ resultadoSimulacao.valorParcela | currency:'BRL' }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <strong>Total a Pagar:</strong>
                                    <span>{{ resultadoSimulacao.totalPagar | currency:'BRL' }}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Total de Juros:</strong>
                                    <span>{{ resultadoSimulacao.totalJuros | currency:'BRL' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analise-credito mt-3" 
                             [class.aprovado]="resultadoSimulacao.aprovado"
                             [class.reprovado]="!resultadoSimulacao.aprovado">
                            <strong>Situação:</strong>
                            <span>{{ resultadoSimulacao.aprovado ? 'APROVADO' : 'REPROVADO' }}</span>
                            <small class="p-d-block p-mt-1">
                                {{ resultadoSimulacao.mensagem }}
                            </small>
                        </div>
                    </p-card>
                </div>

         
            <!-- botoes condicionais -->
            <div class="flex justify-content-center gap-2 mt-4">
                <!-- caso 1: simulacao foi aprovada -->
                <div *ngIf="resultadoSimulacao?.aprovado" class="flex justify-content-center gap-2">
                    <button
                        pButton
                        class="btn-simular"
                        label="Solicitar financiamento"
                        type="button"
                        routerLink="/solicitacao">
                    </button>
                    <button
                        pButton
                        class="p-button-outlined btn-secundary"
                        label="Voltar"
                        type="button"
                        routerLink="/painelcliente">
                    </button>
                </div>

                <!-- caso 2: simulacao foi negada -->
                <div *ngIf="resultadoSimulacao && !resultadoSimulacao.aprovado" class="flex justify-content-center gap-2">
                    <button
                        pButton
                        class="btn-simular"
                        label="Fazer nova simulação"
                        type="button"
                        (click)="novaSimulacao()">
                    </button>
                    <button
                        pButton
                        class="btn-secundary"
                        label="Voltar"                    
                        type="button"
                        routerLink="/painelcliente">
                    </button>
                </div>

                <!-- botao simulacao -->
                <div *ngIf="!resultadoSimulacao" class="flex justify-content-center">
                    <button
                        pButton
                        class="btn-simular"
                        label="Simular Financiamento"
                        type="button"
                        (click)="realizarSimulacao()"
                        [disabled]="!informacoesFipe || carregando">
                    </button>
                </div>
            </div>

            </form>
        </div>
    </div>
</div>