<p-toast></p-toast>
<div class="main-container">
    <div class="content-wrapper">
        <div class="painel">
            <header>
                <div class="header-actions">
                    <button pButton
                            type="button"
                            icon="pi pi-arrow-left"
                            class="p-button-outlined p-button-sm back-button"
                            routerLink="/painelcliente"
                            pTooltip="Voltar ao Painel">
                    </button>
                </div>
                <h2>Simule seu financiamento agora!</h2>
                <p>Escolha o veículo dos seus sonhos e veja as condições ideias para o seu orçamento. </p>
            </header>

            <div class="form-simulacao">
                <div class="consulta-fipe-container">
                    <div class="card">
                        <h2>Consulta Tabela FIPE</h2>
                        <p class="subtitle">Consulte o valor de veículos utilizando a tabela FIPE oficial</p>

                        <div *ngIf="carregando && !listaMarcas.length" class="loading-container">
                            <p-progressSpinner></p-progressSpinner>
                            <p>Carregando...</p>
                        </div>


                        <div class="form-container" *ngIf="!carregando || listaMarcas.length">
                            <div class="p-fluid grid">

                                <div class="field col-12 md:col-6 lg:col-3">
                                    <label for="tipoVeiculo">Tipo de Veículo</label>
                                    <p-dropdown
                                        id="tipoVeiculo"
                                        [options]="listaTiposVeiculo"
                                        [(ngModel)]="tipoVeiculo"
                                        (onChange)="aoMudarTipoVeiculo()"
                                        placeholder="Selecione o tipo"
                                        [disabled]="carregando"
                                        appendTo="body"
                                        name="tipoVeiculo">
                                    </p-dropdown>
                                </div>

                                <div class="field col-12 md:col-6 lg:col-3">
                                    <label for="marca">Marca</label>
                                    <p-dropdown
                                        id="marca"
                                        [options]="listaMarcas"
                                        [(ngModel)]="marcaEscolhida"
                                        (onChange)="aoMudarMarca()"
                                        placeholder="Selecione a marca"
                                        [disabled]="!listaMarcas.length || carregando"
                                        appendTo="body"
                                        name="marca">
                                        <ng-template pTemplate="empty">
                                            <div class="empty-message">
                                                {{ carregando ? 'Carregando...' : 'Nenhuma marca encontrada' }}
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                </div>

                                <div class="field col-12 md:col-6 lg:col-3">
                                    <label for="modelo">Modelo</label>
                                    <p-dropdown
                                        id="modelo"
                                        [options]="listaModelos"
                                        [(ngModel)]="modeloEscolhido"
                                        (onChange)="aoMudarModelo()"
                                        placeholder="Selecione o modelo"
                                        [disabled]="!listaModelos.length || carregando"
                                        appendTo="body"
                                        name="modelo">
                                        <ng-template pTemplate="empty">
                                            <div class="empty-message">
                                                {{ !marcaEscolhida ? 'Selecione uma marca' : (carregando ? 'Carregando...' : 'Nenhum modelo encontrado') }}
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                </div>

                                <div class="field col-12 md:col-6 lg:col-3">
                                    <label for="ano">Ano</label>
                                    <p-dropdown
                                        id="ano"
                                        [options]="listaAnos"
                                        [(ngModel)]="anoEscolhido"
                                        (onChange)="aoMudarAno()"
                                        placeholder="Selecione o ano"
                                        [disabled]="!listaAnos.length || carregando"
                                        appendTo="body"
                                        name="ano">
                                        <ng-template pTemplate="empty">
                                            <div class="empty-message">
                                                {{ !modeloEscolhido ? 'Selecione um modelo' : (carregando ? 'Carregando...' : 'Nenhum ano encontrado') }}
                                            </div>
                                        </ng-template>
                                    </p-dropdown>
                                </div>

                            </div>

                            <div *ngIf="carregando && listaMarcas.length" class="loading-inline">
                                <p-progressSpinner styleClass="w-1rem h-1rem" strokeWidth="4"></p-progressSpinner>
                                <span class="ml-2">Consultando...</span>
                            </div>

                            <div class="flex justify-content-end mt-3">
                                <button
                                    pButton
                                    pRipple
                                    type="button"
                                    label="Limpar Consulta"
                                    class="btn-secundary"
                                    (click)="limparConsulta()"
                                    [disabled]="carregando">
                                </button>
                            </div>
                        </div>

                        <div *ngIf="dadosFipe" class="resultado-container mt-4">
                            <p-card header="Resultado da Consulta FIPE" styleClass="resultado-card" [style]="{'padding': '10px'}">
                                <div class="grid">
                                    <div class="col-12 md:col-6">
                                        <div class="info-item">
                                            <strong>Valor do Veículo:</strong>
                                            <span class="valor-fipe">{{ dadosFipe.Valor }}</span>
                                        </div>

                                    </div>
                                    <div class="col-12 md:col-6">
                                        <div class="info-item">
                                            <strong>Combustível:</strong>
                                            <span>{{ dadosFipe.Combustivel }}</span>
                                        </div>
                                        <div class="info-item">
                                            <strong>Código FIPE:</strong>
                                            <span>{{ dadosFipe.CodigoFipe }}</span>
                                        </div>
                                        <div class="info-item">
                                            <strong>Mês Referência:</strong>
                                            <span>{{ dadosFipe.MesReferencia }}</span>
                                        </div>
                                    </div>
                                </div>
                            </p-card>
                        </div>

                        <div *ngIf="!dadosFipe && formularioEstaValido && !carregando" class="empty-state mt-4">
                            <p-card>
                                <div class="empty-state-content">
                                    <i class="pi pi-info-circle empty-state-icon"></i>
                                    <h3>Consulta Completa</h3>
                                    <p>Selecione o ano do veículo para visualizar o valor FIPE</p>
                                </div>
                            </p-card>
                        </div>
                    </div>
                </div>

                <div *ngIf="dadosFipe" class="campos-simulacao mt-4">
                    <p-card header="Dados para Simulação">
                        <form [formGroup]="formularioSimulacao">
                            <div class="grid">
                                <div class="field col-12 md:col-6">
                                    <label for="valorEntrada">Valor de Entrada (R$)</label>
                                    <p-inputNumber
                                        id="valorEntrada"
                                        formControlName="valorEntrada"
                                        mode="currency"
                                        currency="BRL"
                                        locale="pt-BR"
                                        [min]="0"
                                        [max]="valorNumericoDoVeiculo"
                                        [allowEmpty]="true"
                                        [useGrouping]="true"
                                        placeholder="Digite o valor da entrada">
                                    </p-inputNumber>
                                    <small class="p-d-block p-mt-1">
                                        Valor máximo: {{ valorNumericoDoVeiculo | currency:'BRL' }}
                                    </small>
                                    <small *ngIf="formularioSimulacao.get('valorEntrada')?.invalid && formularioSimulacao.get('valorEntrada')?.touched"
                                           class="p-error p-d-block p-mt-1">
                                        <span *ngIf="formularioSimulacao.get('valorEntrada')?.errors?.['required']">Campo obrigatório</span>
                                        <span *ngIf="formularioSimulacao.get('valorEntrada')?.errors?.['max']">Valor excede o máximo permitido</span>
                                        <span *ngIf="formularioSimulacao.get('valorEntrada')?.errors?.['min']">Valor deve ser maior ou igual a zero</span>
                                    </small>
                                </div>

                                <div class="field col-12 md:col-6">
                                    <label for="parcelas">Número de Parcelas</label>
                                    <p-dropdown
                                        id="parcelas"
                                        [options]="listaParcelas"
                                        formControlName="parcelasSelecionadas"
                                        placeholder="Selecione as parcelas">
                                    </p-dropdown>
                                </div>

                                <div class="field col-12 md:col-6">
                                    <label for="taxaJuros">Taxa de Juros (% ao mês)</label>
                                    <p-inputNumber
                                        id="taxaJuros"
                                        formControlName="taxaJuros"
                                        mode="decimal"
                                        [readonly]="true"
                                        [minFractionDigits]="2"
                                        [maxFractionDigits]="2"
                                        suffix="%">
                                    </p-inputNumber>
                                    <small class="p-d-block p-mt-1" style="color: #64748b;">
                                        Taxa automática baseada no número de parcelas
                                    </small>
                                </div>

                                <div class="field col-12 md:col-6">
                                    <label for="rendaMensal">Renda Mensal (R$)</label>
                                    <p-inputNumber
                                        id="rendaMensal"
                                        formControlName="rendaMensal"
                                        mode="currency"
                                        currency="BRL"
                                        locale="pt-BR"
                                        [min]="0"
                                        [allowEmpty]="true"
                                        [useGrouping]="true"
                                        placeholder="Digite sua renda mensal">
                                    </p-inputNumber>
                                    <small *ngIf="formularioSimulacao.get('rendaMensal')?.invalid && formularioSimulacao.get('rendaMensal')?.touched"
                                           class="p-error p-d-block p-mt-1">
                                        <span *ngIf="formularioSimulacao.get('rendaMensal')?.errors?.['required']">Campo obrigatório</span>
                                        <span *ngIf="formularioSimulacao.get('rendaMensal')?.errors?.['min']">Valor deve ser maior que zero</span>
                                    </small>
                                </div>
                            </div>
                        </form>
                    </p-card>
                </div>

                <div *ngIf="resultadoSimulacao && dadosFipe" class="resultado-simulacao mt-4">
                    <p-card header="Resultado da Simulação" styleClass="resultado-simulacao-card">
                        <div class="grid">
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <strong>Valor Financiado:</strong>
                                    <span>{{ resultadoSimulacao.valorFinanciado | currency:'BRL' }}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Valor da Parcela:</strong>
                                    <span class="valor-parcela">{{ resultadoSimulacao.valorParcela | currency:'BRL' }}</span>
                                </div>
                            </div>
                            <div class="col-12 md:col-6">
                                <div class="info-item">
                                    <strong>Total a Pagar:</strong>
                                    <span>{{ resultadoSimulacao.totalPagar | currency:'BRL' }}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Total de Juros:</strong>
                                    <span>{{ resultadoSimulacao.totalJuros | currency:'BRL' }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="analise-credito mt-3"
                             [class.aprovado]="resultadoSimulacao.aprovado"
                             [class.reprovado]="!resultadoSimulacao.aprovado">
                            <strong>Situação:</strong>
                            <span>{{ resultadoSimulacao.aprovado ? 'APROVADO' : 'REPROVADO' }}</span>
                            <small class="p-d-block p-mt-1">
                                {{ resultadoSimulacao.mensagem }}
                            </small>
                        </div>
                    </p-card>
                </div>


            <div class="flex justify-content-center gap-2 mt-4">
                <!-- caso 1: simulacao foi aprovada -->
                <div *ngIf="resultadoSimulacao?.aprovado" class="flex justify-content-center gap-2">
                    <button
                        pButton
                        class="btn-simular"
                        label="Solicitar financiamento"
                        type="button"
                        (click)="irParaSolicitacao()">
                    </button>
                    <button
                        pButton
                        class="p-button-outlined btn-secundary"
                        label="Voltar"
                        type="button"
                        routerLink="/painelcliente">
                    </button>
                </div>

                <div *ngIf="resultadoSimulacao && !resultadoSimulacao.aprovado" class="flex justify-content-center gap-2">
                    <button
                        pButton
                        class="btn-simular"
                        label="Fazer nova simulação"
                        type="button"
                        (click)="novaSimulacao()">
                    </button>
                    <button
                        pButton
                        class="btn-secundary"
                        label="Voltar"
                        type="button"
                        routerLink="/painelcliente">
                    </button>
                </div>

                <div *ngIf="!resultadoSimulacao" class="flex justify-content-center">
                    <button
                        pButton
                        class="btn-simular"
                        label="Simular Financiamento"
                        type="button"
                        [disabled]="!dadosFipe || formularioSimulacao.invalid || carregando"
                        (click)="calcularSimulacao()">
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>
